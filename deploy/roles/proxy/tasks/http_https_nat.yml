- name: Configure host to NAT to the proxy container
  # gather_facts: True
  vars:
    ansible_connection: local
  become: true
  become_user: root
  ansible.builtin.blockinfile:
    path: /etc/ufw/before.rules
    insertbefore: BOF
    marker: "# {mark} NAT configuration"
    block: |
      *nat
      -F
      :PREROUTING ACCEPT [0:0]
      {% for host in groups['all'] %}
      {% if host == "proxy" %}
      -A PREROUTING -i {{ ansible_default_ipv4.interface }} -p tcp --dport 80 -j  DNAT --to-destination {{ hostvars[host]['ansible_host'] }}:80
      -A PREROUTING -i {{ ansible_default_ipv4.interface }} -p tcp --dport 443 -j  DNAT --to-destination {{hostvars[host]['ansible_host']}}:443
      {% endif %}
      {% endfor %}
      # setup routing
      -A POSTROUTING -s {{lxd_network}} ! -d {{lxd_network}} -j MASQUERADE
      COMMIT
  notify:  Reload ufw
  delegate_to: 127.0.0.1
# lxd proxy device.   
